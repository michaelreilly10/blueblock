<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Block: Laser Escape</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap');
    
    :root {
      --safe-zone-color: rgba(0, 255, 0, 0.15);
      --player-color: #4285F4;
      --exit-color: #34A853;
      --laser-color: #EA4335;
      --camera-color: #FBBC05;
      --background-dark: #121212;
      --background-light: #1E1E1E;
      --text-color: #FFFFFF;
      --text-glow: 0 0 10px rgba(255, 255, 255, 0.7);
    }
    
    * {
      box-sizing: border-box;
      user-select: none;
    }
    
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: var(--background-dark);
      overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      color: var(--text-color);
      text-shadow: var(--text-glow);
    }

    #game-wrapper {
      display: flex;
      position: relative;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }

    #safe-section {
      width: 220px;
      height: 600px;
      background-color: var(--safe-zone-color);
      border-right: 2px solid rgba(0, 255, 0, 0.5);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
    }

    #game-container {
      position: relative;
      width: 800px;
      height: 600px;
      background: 
        radial-gradient(circle at center, var(--background-light) 0%, var(--background-dark) 100%),
        repeating-linear-gradient(
          45deg,
          rgba(30, 30, 30, 0.3),
          rgba(30, 30, 30, 0.3) 2px,
          transparent 2px,
          transparent 4px
        );
      overflow: hidden;
    }

    #blue-block {
      position: absolute;
      width: 40px;
      height: 40px;
      background-color: var(--player-color);
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(66, 133, 244, 0.7);
      transition: transform 0.08s ease-out;
      z-index: 10;
    }

    #blue-block::after {
      content: "";
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      top: 5px;
      left: 5px;
    }

    #exit {
      position: absolute;
      width: 60px;
      height: 60px;
      background-color: var(--exit-color);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(52, 168, 83, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 5;
      transition: all 0.3s;
    }

    #exit.disabled {
      opacity: 0.5;
      box-shadow: 0 0 10px rgba(52, 168, 83, 0.3);
      filter: grayscale(50%);
    }

    #exit:hover {
      transform: scale(1.1);
    }

    #exit::before {
      content: "‚úì";
      font-size: 30px;
      color: white;
    }

    .laser {
      position: absolute;
      z-index: 3;
      box-shadow: 0 0 10px var(--laser-color);
    }

    .vertical-laser {
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, 
        transparent, 
        var(--laser-color), 
        transparent);
      animation: moveVertical 4s linear infinite;
    }

    .horizontal-laser {
      width: 100%;
      height: 4px;
      background: linear-gradient(to right, 
        transparent, 
        var(--laser-color), 
        transparent);
      animation: moveHorizontal 4s linear infinite;
    }

    #hud {
      position: absolute;
      top: 15px;
      left: 15px;
      display: flex;
      gap: 20px;
      z-index: 20;
    }

    .hud-item {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    #controls {
      background-color: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      margin-top: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #controls h3 {
      margin-top: 0;
      color: var(--player-color);
    }

    #controls p {
      margin: 8px 0;
    }

    #level-complete-modal, #game-complete-modal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      border: 2px solid var(--player-color);
      box-shadow: 0 0 30px rgba(66, 133, 244, 0.5);
    }

    .modal-content h2 {
      color: var(--player-color);
      font-size: 28px;
      margin-top: 0;
    }

    button {
      background: linear-gradient(145deg, #4285F4, #3367D6);
      color: white;
      border: none;
      padding: 12px 25px;
      margin-top: 20px;
      border-radius: 5px;
      font-family: 'Orbitron', sans-serif;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
    }

    button:active {
      transform: translateY(1px);
    }

    .particle {
      position: absolute;
      width: 5px;
      height: 5px;
      background-color: white;
      border-radius: 50%;
      pointer-events: none;
      z-index: 15;
    }

    #pause-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 50;
      color: var(--player-color);
      font-size: 36px;
      text-align: center;
    }

    #collectibles-container {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 10px;
      z-index: 20;
    }

    .collectible {
      width: 30px;
      height: 30px;
      background-color: gold;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
    }

    .collectible.empty {
      background-color: rgba(255, 255, 255, 0.1);
      box-shadow: none;
    }

    #tutorial-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 200;
      padding: 30px;
      text-align: center;
    }

    #tutorial-content {
      max-width: 600px;
      background: rgba(30, 30, 30, 0.9);
      padding: 30px;
      border-radius: 10px;
      border: 2px solid var(--player-color);
    }

    #tutorial-content h2 {
      color: var(--player-color);
    }

    .tutorial-section {
      margin-bottom: 20px;
    }

    .tutorial-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 0;
    }

    .key {
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 15px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 40px;
    }

    .collectible-star {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: gold;
      clip-path: polygon(
        50% 0%,
        61% 35%,
        98% 35%,
        68% 57%,
        79% 91%,
        50% 70%,
        21% 91%,
        32% 57%,
        2% 35%,
        39% 35%
      );
      z-index: 6;
      animation: float 2s infinite ease-in-out;
    }

    .checkpoint {
      position: absolute;
      width: 40px;
      height: 40px;
      background-color: rgba(52, 168, 83, 0.3);
      border: 2px dashed var(--exit-color);
      border-radius: 5px;
      z-index: 1;
    }

    @keyframes moveVertical {
      0% { top: -100%; }
      100% { top: 100%; }
    }

    @keyframes moveHorizontal {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0.8; }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    @keyframes flicker {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <div id="safe-section">
      <div id="hud">
        <div class="hud-item" id="level-display">LEVEL: 1</div>
        <div class="hud-item" id="time-display">TIME: 0.00</div>
        <div class="hud-item" id="deaths-display">DEATHS: 0</div>
        <div class="hud-item" id="score-display">SCORE: 0</div>
      </div>
      
      <div id="controls">
        <h3>CONTROLS</h3>
        <p>‚Üë ‚Üì ‚Üê ‚Üí : Move Player</p>
        <p>P : Pause/Unpause</p>
        <p>R : Restart Level</p>
        <p>M : Toggle Music</p>
        <p>H : Show Help</p>
      </div>
    </div>
    
    <div id="game-container" tabindex="0">
      <div id="blue-block"></div>
      <div id="exit" class="disabled"></div>
      
      <div id="collectibles-container"></div>
      
      <div id="level-complete-modal">
        <div class="modal-content">
          <h2>LEVEL COMPLETE!</h2>
          <p id="level-stats">Time: 0.00s | Deaths: 0 | Score: 0</p>
          <p id="bonus-stats"></p>
          <button id="next-level-btn">NEXT LEVEL</button>
        </div>
      </div>
      
      <div id="game-complete-modal">
        <div class="modal-content">
          <h2>MISSION COMPLETE!</h2>
          <p id="final-stats">Total Time: 0.00s | Total Deaths: 0 | Total Score: 0</p>
          <p id="final-bonus"></p>
          <button id="restart-game-btn">PLAY AGAIN</button>
        </div>
      </div>
      
      <div id="pause-overlay">
        <h2>GAME PAUSED</h2>
        <p>Press P to continue</p>
      </div>
      
      <div id="tutorial-overlay">
        <div id="tutorial-content">
          <h2>LASER ESCAPE</h2>
          <div class="tutorial-section">
            <p>Navigate the blue block through dangerous laser fields to reach the exit.</p>
            <p><strong>NEW:</strong> You must collect ALL stars before reaching the exit!</p>
          </div>
          
          <div class="tutorial-section">
            <h3>HOW TO PLAY</h3>
            <div class="tutorial-controls">
              <div class="key">‚Üë</div>
              <div class="key">‚Üì</div>
              <div class="key">‚Üê</div>
              <div class="key">‚Üí</div>
            </div>
            <p>Move your block</p>
          </div>
          
          <div class="tutorial-section">
            <h3>OBJECTIVES</h3>
            <p>‚Ä¢ Reach the green exit to complete each level</p>
            <p>‚Ä¢ Collect ALL gold stars before exiting</p>
            <p>‚Ä¢ Avoid lasers (they will kill you)</p>
            <p>‚Ä¢ Checkpoints save your progress</p>
          </div>
          
          <button id="start-game-btn">START GAME</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sound Effects -->
  <audio id="laser-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-laser-weapon-shot-1680.mp3" preload="auto"></audio>
  <audio id="death-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3" preload="auto"></audio>
  <audio id="win-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
  <audio id="level-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>
  <audio id="collect-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1992.mp3" preload="auto"></audio>
  <audio id="checkpoint-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" preload="auto"></audio>
  
  <!-- Background Music -->
  <audio id="bg-music" loop preload="auto">
    <source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Game elements
    const blueBlock = document.getElementById('blue-block');
    const gameContainer = document.getElementById('game-container');
    const exit = document.getElementById('exit');
    const levelDisplay = document.getElementById('level-display');
    const timeDisplay = document.getElementById('time-display');
    const deathsDisplay = document.getElementById('deaths-display');
    const scoreDisplay = document.getElementById('score-display');
    const levelCompleteModal = document.getElementById('level-complete-modal');
    const gameCompleteModal = document.getElementById('game-complete-modal');
    const levelStats = document.getElementById('level-stats');
    const finalStats = document.getElementById('final-stats');
    const bonusStats = document.getElementById('bonus-stats');
    const finalBonus = document.getElementById('final-bonus');
    const nextLevelBtn = document.getElementById('next-level-btn');
    const restartGameBtn = document.getElementById('restart-game-btn');
    const pauseOverlay = document.getElementById('pause-overlay');
    const collectiblesContainer = document.getElementById('collectibles-container');
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const startGameBtn = document.getElementById('start-game-btn');

    // Sound effects
    const laserSound = document.getElementById('laser-sound');
    const deathSound = document.getElementById('death-sound');
    const winSound = document.getElementById('win-sound');
    const levelSound = document.getElementById('level-sound');
    const collectSound = document.getElementById('collect-sound');
    const checkpointSound = document.getElementById('checkpoint-sound');
    const bgMusic = document.getElementById('bg-music');

    // Game state
    let blueBlockX = 20;
    let blueBlockY = 280;
    let currentLevel = 1;
    let totalDeaths = 0;
    let levelDeaths = 0;
    let gameStartTime = 0;
    let levelStartTime = 0;
    let gameTime = 0;
    let levelTime = 0;
    let score = 0;
    let levelScore = 0;
    let gameActive = false;
    let gamePaused = false;
    let musicOn = true;
    let animationFrameId;
    let lasers = [];
    let particles = [];
    let collectibles = [];
    let checkpoints = [];
    let totalCollectibles = 0;
    let collectedCount = 0;
    let lastCheckpoint = { x: 20, y: 280 };
    let levelCompleted = false;
    
    // Movement variables for smoother controls
    let targetX = 20;
    let targetY = 280;
    const moveSpeed = 0.2;
    const moveDistance = 10;

    // Enhanced level configurations with safe spawn points (cameras removed)
    const levels = [
      { // Level 1 - Basic lasers
        name: "LASER TRAINING",
        lasers: [
          { type: 'vertical', left: 200, animationDuration: 4, delay: 0 },
          { type: 'vertical', left: 500, animationDuration: 4, delay: 2 },
          { type: 'horizontal', top: 100, animationDuration: 3, delay: 1 },
          { type: 'horizontal', top: 400, animationDuration: 3, delay: 1.5 }
        ],
        exit: { right: 50, top: 280 },
        collectibles: [
          { x: 300, y: 150 },
          { x: 400, y: 450 },
          { x: 600, y: 300 }
        ],
        checkpoints: [
          { x: 400, y: 280 }
        ],
        safeSpawn: { x: 20, y: 280 }
      },
      { // Level 2 - Modified spawn point
        name: "SECURITY BREACH",
        lasers: [
          { type: 'vertical', left: 150, animationDuration: 2, delay: 0 },
          { type: 'vertical', left: 450, animationDuration: 3, delay: 1 },
          { type: 'horizontal', top: 50, animationDuration: 2.5, delay: 0.5 },
          { type: 'horizontal', top: 300, animationDuration: 4, delay: 0 },
          { type: 'horizontal', top: 450, animationDuration: 3.5, delay: 1 }
        ],
        exit: { right: 50, top: 50 },
        collectibles: [
          { x: 200, y: 200 },
          { x: 500, y: 100 },
          { x: 400, y: 400 },
          { x: 700, y: 500 }
        ],
        checkpoints: [
          { x: 300, y: 300 },
          { x: 600, y: 100 }
        ],
        safeSpawn: { x: 20, y: 100 }
      },
      { // Level 3
        name: "FINAL CHALLENGE",
        lasers: [
          { type: 'vertical', left: 100, animationDuration: 1.5, delay: 0 },
          { type: 'vertical', left: 300, animationDuration: 2, delay: 0.5 },
          { type: 'vertical', left: 500, animationDuration: 1.8, delay: 0.3 },
          { type: 'horizontal', top: 100, animationDuration: 2.2, delay: 0 },
          { type: 'horizontal', top: 250, animationDuration: 3, delay: 0.7 },
          { type: 'horizontal', top: 400, animationDuration: 2.5, delay: 0.4 }
        ],
        exit: { right: 50, top: 450 },
        collectibles: [
          { x: 150, y: 500 },
          { x: 350, y: 300 },
          { x: 550, y: 150 },
          { x: 700, y: 400 },
          { x: 400, y: 550 }
        ],
        checkpoints: [
          { x: 250, y: 450 },
          { x: 500, y: 250 }
        ],
        safeSpawn: { x: 20, y: 280 }
      },
      { // Level 4 - Bonus level
        name: "LASER MAZE",
        lasers: [
          { type: 'vertical', left: 150, animationDuration: 1.2, delay: 0 },
          { type: 'vertical', left: 300, animationDuration: 1.8, delay: 0.3 },
          { type: 'vertical', left: 450, animationDuration: 1.5, delay: 0.6 },
          { type: 'vertical', left: 600, animationDuration: 2, delay: 0.9 },
          { type: 'horizontal', top: 75, animationDuration: 1.4, delay: 0 },
          { type: 'horizontal', top: 200, animationDuration: 1.6, delay: 0.4 },
          { type: 'horizontal', top: 325, animationDuration: 1.8, delay: 0.8 },
          { type: 'horizontal', top: 450, animationDuration: 2, delay: 1.2 }
        ],
        exit: { right: 50, top: 250 },
        collectibles: [
          { x: 200, y: 100 },
          { x: 400, y: 100 },
          { x: 600, y: 100 },
          { x: 200, y: 300 },
          { x: 400, y: 300 },
          { x: 600, y: 300 },
          { x: 200, y: 500 },
          { x: 400, y: 500 },
          { x: 600, y: 500 }
        ],
        checkpoints: [
          { x: 350, y: 200 },
          { x: 350, y: 400 }
        ],
        safeSpawn: { x: 20, y: 280 }
      }
    ];

    // Initialize the game
    function initGame() {
      gameStartTime = Date.now();
      levelStartTime = Date.now();
      totalDeaths = 0;
      currentLevel = 1;
      score = 0;
      gameActive = true;
      gamePaused = false;
      levelCompleted = false;
      
      updateHUD();
      initializeLevel(currentLevel);
      gameLoop();
      
      // Start background music
      if (musicOn) {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(e => console.log("Autoplay prevented:", e));
      }
      
      // Focus the game container for keyboard input
      gameContainer.focus();
    }

    // Initialize a level
    function initializeLevel(level) {
      levelCompleted = false;
      // Clear existing elements
      gameContainer.querySelectorAll('.laser, .particle, .collectible-star, .checkpoint').forEach(el => el.remove());
      lasers = [];
      particles = [];
      collectibles = [];
      checkpoints = [];
      levelDeaths = 0;
      levelScore = 0;
      collectedCount = 0;
      levelStartTime = Date.now();
      
      const levelConfig = levels[level - 1];
      totalCollectibles = levelConfig.collectibles.length;
      
      // Set initial spawn point from level configuration
      lastCheckpoint = { ...levelConfig.safeSpawn };
      targetX = lastCheckpoint.x;
      targetY = lastCheckpoint.y;
      
      // Position exit
      exit.style.right = `${levelConfig.exit.right}px`;
      exit.style.top = `${levelConfig.exit.top}px`;
      exit.classList.add('disabled');
      
      // Add lasers with proper positioning
      levelConfig.lasers.forEach(laser => {
        const laserEl = document.createElement('div');
        laserEl.classList.add('laser');
        laserEl.classList.add(laser.type === 'vertical' ? 'vertical-laser' : 'horizontal-laser');
        
        if (laser.type === 'vertical') {
          laserEl.style.left = `${laser.left}px`;
          laserEl.style.top = '-100%';
        } else {
          laserEl.style.left = '-100%';
          laserEl.style.top = `${laser.top}px`;
        }
        
        laserEl.style.animationDuration = `${laser.animationDuration}s`;
        laserEl.style.animationDelay = `-${laser.delay}s`;
        gameContainer.appendChild(laserEl);
        lasers.push(laserEl);
      });
      
      // Add collectibles with proper positioning
      levelConfig.collectibles.forEach((collectible, index) => {
        const star = document.createElement('div');
        star.classList.add('collectible-star');
        star.style.left = `${collectible.x}px`;
        star.style.top = `${collectible.y}px`;
        star.dataset.collected = "false";
        star.dataset.index = index;
        gameContainer.appendChild(star);
        collectibles.push(star);
      });
      
      // Add checkpoints
      levelConfig.checkpoints.forEach(checkpoint => {
        const cp = document.createElement('div');
        cp.classList.add('checkpoint');
        cp.style.left = `${checkpoint.x}px`;
        cp.style.top = `${checkpoint.y}px`;
        gameContainer.appendChild(cp);
        checkpoints.push(cp);
      });
      
      // Update collectibles display
      updateCollectiblesDisplay();
      
      // Update HUD
      levelDisplay.textContent = `LEVEL: ${level} - ${levelConfig.name}`;
      resetPlayer();
    }

    // Reset player position safely
    function resetPlayer() {
      // First try the designated spawn point
      if (isPositionSafe(lastCheckpoint.x, lastCheckpoint.y)) {
        blueBlockX = lastCheckpoint.x;
        blueBlockY = lastCheckpoint.y;
        targetX = lastCheckpoint.x;
        targetY = lastCheckpoint.y;
      } else {
        // Fallback to level's safe spawn point
        blueBlockX = levels[currentLevel - 1].safeSpawn.x;
        blueBlockY = levels[currentLevel - 1].safeSpawn.y;
        targetX = blueBlockX;
        targetY = blueBlockY;
      }
      
      // Ensure we don't spawn inside exit
      const exitRect = {
        left: 800 - parseInt(exit.style.right) - 30,
        top: parseInt(exit.style.top),
        right: 800 - parseInt(exit.style.right) + 30,
        bottom: parseInt(exit.style.top) + 60
      };
      
      const playerRect = {
        left: blueBlockX,
        top: blueBlockY,
        right: blueBlockX + 40,
        bottom: blueBlockY + 40
      };
      
      if (rectsOverlap(playerRect, exitRect)) {
        blueBlockX = levels[currentLevel - 1].safeSpawn.x;
        blueBlockY = levels[currentLevel - 1].safeSpawn.y;
        targetX = blueBlockX;
        targetY = blueBlockY;
      }
      
      blueBlock.style.left = `${blueBlockX}px`;
      blueBlock.style.top = `${blueBlockY}px`;
    }

    // Update collectibles display
    function updateCollectiblesDisplay() {
      collectiblesContainer.innerHTML = '';
      
      for (let i = 0; i < totalCollectibles; i++) {
        const collectible = document.createElement('div');
        collectible.classList.add('collectible');
        if (i < collectedCount) {
          collectible.textContent = '‚òÖ';
        } else {
          collectible.classList.add('empty');
        }
        collectiblesContainer.appendChild(collectible);
      }
      
      // Update exit state based on collectibles
      if (collectedCount >= totalCollectibles) {
        exit.classList.remove('disabled');
      } else {
        exit.classList.add('disabled');
      }
    }

    // Game loop
    function gameLoop() {
      if (gamePaused || !gameActive || levelCompleted) return;
      
      // Smooth movement interpolation
      blueBlockX += (targetX - blueBlockX) * moveSpeed;
      blueBlockY += (targetY - blueBlockY) * moveSpeed;
      
      // Update player position
      blueBlock.style.left = `${blueBlockX}px`;
      blueBlock.style.top = `${blueBlockY}px`;
      
      updateGameTime();
      updateParticles();
      checkCollisions();
      checkCollectibles();
      checkCheckpoints();
      
      animationFrameId = requestAnimationFrame(gameLoop);
    }

    // Update game time
    function updateGameTime() {
      const now = Date.now();
      gameTime = (now - gameStartTime) / 1000;
      levelTime = (now - levelStartTime) / 1000;
      
      timeDisplay.textContent = `TIME: ${gameTime.toFixed(2)}`;
    }

    // Update particles
    function updateParticles() {
      particles.forEach((particle, index) => {
        const vx = parseFloat(particle.dataset.vx);
        const vy = parseFloat(particle.dataset.vy);
        const life = parseFloat(particle.dataset.life) - 1;
        
        if (life <= 0) {
          particle.remove();
          particles.splice(index, 1);
        } else {
          const x = parseFloat(particle.style.left) + vx;
          const y = parseFloat(particle.style.top) + vy;
          
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          particle.style.opacity = life / 60;
          particle.dataset.life = life;
        }
      });
    }

    // Update HUD
    function updateHUD() {
      deathsDisplay.textContent = `DEATHS: ${totalDeaths}`;
      scoreDisplay.textContent = `SCORE: ${score}`;
    }

    // Check collisions with precise laser detection - MODIFIED VERSION
    function checkCollisions() {
      const playerRect = {
        left: blueBlockX,
        top: blueBlockY,
        right: blueBlockX + 40,
        bottom: blueBlockY + 40
      };

      // Check exit collision
      const exitRect = {
        left: 800 - parseInt(exit.style.right) - 30,
        top: parseInt(exit.style.top),
        right: 800 - parseInt(exit.style.right) + 30,
        bottom: parseInt(exit.style.top) + 60
      };

      if (rectsOverlap(playerRect, exitRect)) {
        if (collectedCount >= totalCollectibles) {
          completeLevel();
        } else {
          if (!bonusStats.textContent.includes("collect all")) {
            bonusStats.textContent = `You need to collect all ${totalCollectibles} stars before exiting!`;
            setTimeout(() => {
              bonusStats.textContent = '';
            }, 2000);
          }
        }
        return;
      }

      // PRECISE LASER COLLISION DETECTION - MODIFIED TO ONLY DETECT ACTUAL LASER BEAM
      lasers.forEach(laser => {
        if (laser.classList.contains('vertical-laser')) {
          const laserX = parseInt(laser.style.left);
          
          // Only check if player is horizontally aligned with laser
          if (playerRect.right > laserX && playerRect.left < laserX + 4) {
            // Get current animation progress (0-1)
            const animation = getComputedStyle(laser).getPropertyValue('animation');
            const duration = parseFloat(laser.style.animationDuration) * 1000;
            const delay = parseFloat(laser.style.animationDelay) * 1000;
            const elapsed = (Date.now() - levelStartTime + delay) % duration;
            const progress = elapsed / duration;
            
            // Calculate current laser beam position (0-600)
            const laserBeamTop = progress * 600;
            const laserBeamBottom = laserBeamTop + 20; // 20px tall beam
            
            // Check if player overlaps with actual laser beam
            if (playerRect.bottom > laserBeamTop && playerRect.top < laserBeamBottom) {
              playerDeath();
              return;
            }
          }
        } else {
          // Horizontal laser collision
          const laserY = parseInt(laser.style.top);
          
          // Only check if player is vertically aligned with laser
          if (playerRect.bottom > laserY && playerRect.top < laserY + 4) {
            // Get current animation progress (0-1)
            const duration = parseFloat(laser.style.animationDuration) * 1000;
            const delay = parseFloat(laser.style.animationDelay) * 1000;
            const elapsed = (Date.now() - levelStartTime + delay) % duration;
            const progress = elapsed / duration;
            
            // Calculate current laser beam position (0-800)
            const laserBeamLeft = progress * 800;
            const laserBeamRight = laserBeamLeft + 20; // 20px wide beam
            
            // Check if player overlaps with actual laser beam
            if (playerRect.right > laserBeamLeft && playerRect.left < laserBeamRight) {
              playerDeath();
              return;
            }
          }
        }
      });
    }

    // Check collectibles
    function checkCollectibles() {
      const playerRect = {
        left: blueBlockX,
        top: blueBlockY,
        right: blueBlockX + 40,
        bottom: blueBlockY + 40
      };
      
      collectibles.forEach(collectible => {
        if (collectible.dataset.collected === "false") {
          const collectibleRect = {
            left: parseFloat(collectible.style.left),
            top: parseFloat(collectible.style.top),
            right: parseFloat(collectible.style.left) + 20,
            bottom: parseFloat(collectible.style.top) + 20
          };
          
          if (rectsOverlap(playerRect, collectibleRect)) {
            collectSound.currentTime = 0;
            collectSound.play();
            
            collectible.dataset.collected = "true";
            collectible.style.display = "none";
            collectedCount++;
            levelScore += 100;
            score += 100;
            
            updateCollectiblesDisplay();
            updateHUD();
            
            createParticles(
              parseFloat(collectible.style.left) + 10,
              parseFloat(collectible.style.top) + 10,
              15,
              'gold'
            );
          }
        }
      });
    }

    // Check checkpoints
    function checkCheckpoints() {
      const playerRect = {
        left: blueBlockX,
        top: blueBlockY,
        right: blueBlockX + 40,
        bottom: blueBlockY + 40
      };
      
      checkpoints.forEach(checkpoint => {
        const checkpointRect = {
          left: parseFloat(checkpoint.style.left),
          top: parseFloat(checkpoint.style.top),
          right: parseFloat(checkpoint.style.left) + 40,
          bottom: parseFloat(checkpoint.style.top) + 40
        };
        
        if (rectsOverlap(playerRect, checkpointRect)) {
          const newX = parseFloat(checkpoint.style.left);
          const newY = parseFloat(checkpoint.style.top);
          
          // Only update if this is a new AND SAFE checkpoint
          if ((lastCheckpoint.x !== newX || lastCheckpoint.y !== newY) && 
              isPositionSafe(newX, newY)) {
            checkpointSound.currentTime = 0;
            checkpointSound.play();
            
            lastCheckpoint = { x: newX, y: newY };
            checkpoint.style.border = "2px solid #34A853";
            checkpoint.style.animation = "pulse 1s infinite";
            
            createParticles(
              parseFloat(checkpoint.style.left) + 20,
              parseFloat(checkpoint.style.top) + 20,
              20,
              '#34A853'
            );
          }
        }
      });
    }

    // Check if a position is safe from hazards
    function isPositionSafe(x, y) {
      // Create a temporary rectangle for the player at the test position
      const testRect = {
        left: x,
        top: y,
        right: x + 40,
        bottom: y + 40
      };

      // Check against lasers
      for (const laser of lasers) {
        if (laser.classList.contains('vertical-laser')) {
          const laserX = parseInt(laser.style.left);
          if (testRect.right > laserX && testRect.left < laserX + 4) {
            return false;
          }
        } else {
          const laserY = parseInt(laser.style.top);
          if (testRect.bottom > laserY && testRect.top < laserY + 4) {
            return false;
          }
        }
      }

      return true;
    }

    // Helper function to check rectangle overlap
    function rectsOverlap(rect1, rect2) {
      return !(
        rect1.right < rect2.left || 
        rect1.left > rect2.right || 
        rect1.bottom < rect2.top || 
        rect1.top > rect2.bottom
      );
    }

    // Handle player death
    function playerDeath() {
      deathSound.currentTime = 0;
      deathSound.play();
      
      createParticles(blueBlockX + 20, blueBlockY + 20, 25, '#4285F4');
      
      totalDeaths++;
      levelDeaths++;
      updateHUD();
      resetPlayer();
    }

    // Create particles effect
    function createParticles(x, y, count, color) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.backgroundColor = color;
        
        // Random velocity
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;
        
        particle.dataset.vx = vx;
        particle.dataset.vy = vy;
        particle.dataset.life = 30 + Math.random() * 30;
        
        gameContainer.appendChild(particle);
        particles.push(particle);
      }
    }

    // Complete level
    function completeLevel() {
      levelCompleted = true;
      levelSound.currentTime = 0;
      levelSound.play();
      
      gameActive = false;
      cancelAnimationFrame(animationFrameId);
      
      // Calculate time bonus (faster = more points)
      const timeBonus = Math.max(0, 500 - Math.floor(levelTime * 5));
      
      // Calculate collection bonus
      const collectionBonus = collectedCount * 200;
      
      // Calculate perfect bonus
      const perfectBonus = (collectedCount === totalCollectibles && levelDeaths === 0) ? 1000 : 0;
      
      // Add bonuses to score
      const totalBonus = timeBonus + collectionBonus + perfectBonus;
      levelScore += totalBonus;
      score += totalBonus;
      updateHUD();
      
      levelStats.textContent = `Time: ${levelTime.toFixed(2)}s | Deaths: ${levelDeaths} | Score: ${levelScore}`;
      bonusStats.textContent = `Time Bonus: ${timeBonus} | Collection Bonus: ${collectionBonus} ${perfectBonus > 0 ? '| Perfect Bonus: 1000' : ''}`;
      
      if (currentLevel >= levels.length) {
        // Game complete
        finalStats.textContent = `Total Time: ${gameTime.toFixed(2)}s | Total Deaths: ${totalDeaths} | Total Score: ${score}`;
        
        // Calculate final bonuses
        const timeRank = getTimeRank(gameTime);
        const deathRank = getDeathRank(totalDeaths);
        const scoreRank = getScoreRank(score);
        
        finalBonus.textContent = `Time Rank: ${timeRank} | Death Rank: ${deathRank} | Score Rank: ${scoreRank}`;
        
        gameCompleteModal.style.display = 'flex';
        winSound.play();
      } else {
        // Level complete
        levelCompleteModal.style.display = 'flex';
      }
    }

    // Ranking functions
    function getTimeRank(time) {
      if (time < 60) return "‚ö° Lightning Fast";
      if (time < 120) return "üèéÔ∏è Speedy";
      if (time < 180) return "üö∂ Steady";
      return "üê¢ Slowpoke";
    }

    function getDeathRank(deaths) {
      if (deaths === 0) return "üëë Flawless";
      if (deaths < 5) return "üéØ Precise";
      if (deaths < 10) return "üí™ Persistent";
      return "üíÄ Reckless";
    }

    function getScoreRank(score) {
      if (score > 5000) return "üåü Legendary";
      if (score > 3000) return "üíé Diamond";
      if (score > 2000) return "ü•á Gold";
      if (score > 1000) return "ü•à Silver";
      return "ü•â Bronze";
    }

    // Start next level
    function nextLevel() {
      if (levelCompleted) {
        currentLevel++;
        levelCompleteModal.style.display = 'none';
        gameActive = true;
        initializeLevel(currentLevel);
        gameLoop();
      }
    }

    // Restart game
    function restartGame() {
      gameCompleteModal.style.display = 'none';
      levelCompleteModal.style.display = 'none';
      initGame();
    }

    // Toggle pause
    function togglePause() {
      gamePaused = !gamePaused;
      if (gamePaused) {
        cancelAnimationFrame(animationFrameId);
        pauseOverlay.style.display = 'flex';
        bgMusic.pause();
      } else {
        pauseOverlay.style.display = 'none';
        if (musicOn) bgMusic.play();
        gameLoop();
      }
    }

    // Toggle music
    function toggleMusic() {
      musicOn = !musicOn;
      if (musicOn) {
        bgMusic.play();
      } else {
        bgMusic.pause();
      }
    }

    // Show tutorial
    function showTutorial() {
      tutorialOverlay.style.display = 'flex';
      gamePaused = true;
      cancelAnimationFrame(animationFrameId);
    }

    // Hide tutorial
    function hideTutorial() {
      tutorialOverlay.style.display = 'none';
      gamePaused = false;
      if (gameActive) gameLoop();
    }

    // Handle keyboard input
    gameContainer.addEventListener('keydown', (e) => {
      if (!gameActive && !gamePaused) return;
      
      switch (e.key) {
        case 'ArrowUp':
          targetY = Math.max(0, targetY - moveDistance);
          break;
        case 'ArrowDown':
          targetY = Math.min(560, targetY + moveDistance);
          break;
        case 'ArrowLeft':
          targetX = Math.max(0, targetX - moveDistance);
          break;
        case 'ArrowRight':
          targetX = Math.min(760, targetX + moveDistance);
          break;
        case 'r':
        case 'R':
          resetPlayer();
          break;
        case 'p':
        case 'P':
          togglePause();
          break;
        case 'm':
        case 'M':
          toggleMusic();
          break;
        case 'h':
        case 'H':
          showTutorial();
          break;
      }
    });

    // Button event listeners
    nextLevelBtn.addEventListener('click', nextLevel);
    restartGameBtn.addEventListener('click', restartGame);
    startGameBtn.addEventListener('click', () => {
      hideTutorial();
      initGame();
    });

    // Start with tutorial
    showTutorial();
  </script>
</body>
</html>